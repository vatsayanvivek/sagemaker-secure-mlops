name: Deploy MLOps Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: dev

jobs:
  validate:
    name: Validate Templates
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate infrastructure templates
        run: |
          for template in infrastructure/*.yaml; do
            echo "Validating $template"
            aws cloudformation validate-template --template-body file://$template
          done

      - name: Validate pipeline templates
        run: |
          for template in pipeline/*.yaml; do
            echo "Validating $template"
            aws cloudformation validate-template --template-body file://$template
          done

      - name: Validate monitoring templates
        run: |
          for template in monitoring/*.yaml; do
            echo "Validating $template"
            aws cloudformation validate-template --template-body file://$template
          done

  cfn-lint:
    name: CloudFormation Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install cfn-lint
        run: pip install cfn-lint

      - name: Run cfn-lint
        run: cfn-lint infrastructure/*.yaml pipeline/*.yaml monitoring/*.yaml

  deploy-infra:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [validate, cfn-lint]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Network
        run: |
          aws cloudformation deploy \
            --template-file infrastructure/network.yaml \
            --stack-name mlops-${{ env.ENVIRONMENT }}-network \
            --parameter-overrides Environment=${{ env.ENVIRONMENT }} \
            --no-fail-on-empty-changeset

      - name: Deploy KMS
        run: |
          aws cloudformation deploy \
            --template-file infrastructure/kms-keys.yaml \
            --stack-name mlops-${{ env.ENVIRONMENT }}-kms \
            --parameter-overrides Environment=${{ env.ENVIRONMENT }} \
            --no-fail-on-empty-changeset

      - name: Deploy S3
        run: |
          KMS_ARN=$(aws cloudformation describe-stacks \
            --stack-name mlops-${{ env.ENVIRONMENT }}-kms \
            --query 'Stacks[0].Outputs[?OutputKey==`KMSKeyArn`].OutputValue' \
            --output text)
          aws cloudformation deploy \
            --template-file infrastructure/s3-buckets.yaml \
            --stack-name mlops-${{ env.ENVIRONMENT }}-storage \
            --parameter-overrides Environment=${{ env.ENVIRONMENT }} KMSKeyArn=$KMS_ARN \
            --no-fail-on-empty-changeset

      - name: Deploy IAM Roles
        run: |
          aws cloudformation deploy \
            --template-file infrastructure/sagemaker-roles.yaml \
            --stack-name mlops-${{ env.ENVIRONMENT }}-roles \
            --parameter-overrides Environment=${{ env.ENVIRONMENT }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset
